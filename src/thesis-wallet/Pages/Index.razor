@page "/"
@inject IJSRuntime jsRuntime;
@inject IEthereumHostProvider _ethereumHostProvider;
@inject NethereumAuthenticator  _nethereumAuthenticator;
@using Nethereum.ABI.FunctionEncoding
@using Nethereum.Contracts
@using Nethereum.Hex.HexTypes;
@using System.IO
@using System.Text.Json;
@using System.Text.Json.Serialization;
@using Nethereum.Web3
@using Newtonsoft.Json
@using Newtonsoft.Json.Linq
@using System.Text
@using System.Xml.Serialization
@using System.Xml
@using System.Collections
@using System.Threading
@using System.Numerics


@if (EthereumAvailable == true && !string.IsNullOrEmpty(menu.SelectedAccount)) {
    <MatDialog @bind-IsOpen="@menu.existingDialogIsOpen">
        <MatDialogTitle>Join existing contract</MatDialogTitle>
        <MatDialogContent>
            <p>Das Contract address</p>
            <MatTextField Outlined="true" @bind-Value="@menu.dasContractAddress" style="width:30em;"></MatTextField>
            <p>Das Contract Form file (xml)</p>
            <InputFile OnChange="menu.LoadFilesDialog" accept=".xml" />
        </MatDialogContent>
        <MatDialogActions>
            <MatButton OnClick="@menu.CancelExistingContractDialog">Cancel</MatButton>
            <MatButton OnClick="@menu.SubmitExistingContractDialog">Add</MatButton>
        </MatDialogActions>
    </MatDialog>
    <MatDialog @bind-IsOpen="@menu.newDialogIsOpen">
        <MatDialogTitle>Create new contract</MatDialogTitle>
        <MatDialogContent>
            <p>Das Contract bytecode</p>
            <MatTextField Outlined="true" @bind-Value="@menu.dasContractByteCode" style="width:30em;"></MatTextField>
            <p>Das Contract constructor parameters</p>
            <MatTextField Outlined="true" @bind-Value="@menu.dasContractConstructorParams" style="width:30em;"></MatTextField>
            <p>Das Contract Form file (xml)</p>
            <InputFile OnChange="menu.LoadFilesDialog" accept=".xml" />
        </MatDialogContent>
        <MatDialogActions>
            <MatButton OnClick="@menu.CancelNewContractDialog">Cancel</MatButton>
            <MatButton OnClick="@menu.SubmitNewContractDialog">Add</MatButton>
        </MatDialogActions>
    </MatDialog>
    <div class="mat-layout-grid">
        <div class="mat-layout-grid-inner">
            <div class="mat-layout-grid-cell mat-layout-grid-cell-span-3">
                <div class="mat-layout-grid-inner">
                    <div class="mat-layout-grid-cell mat-layout-grid-cell-align-middle mat-layout-grid-cell-span-4">
                        <div style="display:flex;justify-content:center;">
                            <MatFAB Icon="@MatIconNames.Home" Raised="true" OnClick="@menu.LoadDashboard"></MatFAB>
                        </div>
                        <div style="display:flex;justify-content:center;">
                            <MatButtonLink Href="" Style="font-size:0.8em" OnClick="@menu.LoadDashboard">Dashboard</MatButtonLink>
                        </div>
                    </div>
                    <div class="mat-layout-grid-cell mat-layout-grid-cell-span-4">
                        <div style="display:flex;justify-content:center;">
                            <MatFAB Icon="@MatIconNames.Note_add" Raised="true" OnClick="@menu.OpenNewContractDialog"></MatFAB>
                        </div>
                        <div style="display:flex;justify-content:center;">
                            <MatButtonLink Href="" Style="font-size:0.8em" OnClick="@menu.OpenNewContractDialog">New contract</MatButtonLink>
                        </div>
                    </div>
                    <div class="mat-layout-grid-cell mat-layout-grid-cell-span-4">
                        <div style="display:flex;justify-content:center;">
                            <MatFAB Icon="@MatIconNames.Pageview" Raised="true" OnClick="@menu.OpenExistingContractDialog"></MatFAB>
                        </div>
                        <div style="display:flex;justify-content:center;">
                            <MatButtonLink Href="" Style="font-size:0.8em" OnClick="@menu.OpenExistingContractDialog">Join existing</MatButtonLink>
                        </div>
                    </div>
                </div>
                <br />
                <MatDivider></MatDivider>
                <MatH5 Style="text-align:center;line-height:110%;padding-top:0.2em">Contract list</MatH5>
                <MatDivider></MatDivider>
                <MatTreeView TNode="TreeNodeModel" IsNodeExpandedCallback="@menu.ItemIsExpanded" RootNodes="@menu.ViewRootsDisplayed" GetChildNodesCallback="@((n)=>n.Nodes)" @bind-SelectedNode="@menu.SelectedNode" @bind-SelectedNode:event="SelectedNodeChanged">
                    <NodeTemplate>
                        @context.Name
                    </NodeTemplate>
                </MatTreeView>
            </div>
            <div class="mat-layout-grid-cell mat-layout-grid-cell-span-9">
                @if (menu != null && menu.SelectedNode != null && menu.SelectedNode.Form != null) {
                    <CascadingValue Value="@menu.SelectedNode">
                        <CascadingValue Value="@menu.SelectedNode.Form">
                            <DForm @ref="menu._DForm"></DForm>
                        </CascadingValue>
                    </CascadingValue>
            } else {
                    <MatH5>Welcome back!</MatH5>
                }
            </div>
        </div>
    </div>
} else {
     <Metamask />
}


@code{
    DasContractMenu menu = new DasContractMenu();
    bool EthereumAvailable { get; set; }

    protected override async Task OnInitializedAsync() {
        menu.Component = this;
        _ethereumHostProvider.SelectedAccountChanged += AccountChanged;
        EthereumAvailable = await _ethereumHostProvider.CheckProviderAvailabilityAsync();
        menu.w3 = await _ethereumHostProvider.GetWeb3Async();
    }

    private async Task AccountChanged(string account) {
        menu.SelectedAccount = account;
        menu.LoadFormData(menu.SelectedNode);
        await this.InvokeAsync(StateHasChanged);
    }

    /* MENU */
    public class TreeNodeModel {
        private DasContractMenu Menu { get; set; }
        public string Name { get; set; }
        public DasContractItem DasContractItem { get; set; }
        public Form Form { get; set; }
        public List<TreeNodeModel> Nodes { get; set; } = new List<TreeNodeModel>();
        public bool IsExpanded { get; set; } = true;
        public string MyETHAddress { get; set; }
        public Web3 w3 { get; set; }

        public TreeNodeModel(string name, string address = null, Web3 w = null, DasContractMenu menu = null, DasContractItem contract = null, Form form = null) {
            Menu = menu;
            w3 = w;
            Name = name;
            DasContractItem = contract;
            Form = form;
        }

        public async void SubmitSmartContractFunction() {
            Contract contract = w3.Eth.GetContract(DasContractItem.DasContract.ABI, DasContractItem.ContractAddress);
            JArray callableFunctions = JArray.Parse(DasContractItem.DasContract.ABI);
            JObject desiredFunc = null;
            foreach (JObject callableFunction in callableFunctions) {
                if (callableFunction["name"]?.ToString() == Form.FuncBind) {
                    desiredFunc = callableFunction;
                }
            }
            if (desiredFunc == null) {
                Console.WriteLine($"Unable to submit form {Form.Label} because the function {Form.FuncBind} does not exist in the smart contract.");
                return;
            }
            List<object> inputs = new List<object>();
            string paymentValue = "0";
            foreach (var input in ((JArray)desiredFunc["inputs"])) {
                string toSearchFor = input["name"].ToString();
                bool founds = false;
                foreach (FieldGroup fieldGroup in Form.FieldGroups) {
                    foreach (Field field in fieldGroup.Fields) {
                        if (field.ParamBind == toSearchFor) {
                            inputs.Add(field.GetData());
                            founds = true;
                            break;
                        }
                    }
                    if (founds) {
                        break;
                    }
                }
                if (!founds) {
                    Console.WriteLine($"Unable to submit form {Form.Label} because the parameter {toSearchFor} was not provided for the function {Form.FuncBind}.");
                    return;
                }
            }
            bool found = false;
            foreach (FieldGroup fieldGroup in Form.FieldGroups) {
                foreach (Field field in fieldGroup.Fields) {
                    if (field.ParamBind == "const:payValue") {
                        paymentValue = field.GetData().ToString();
                        found = true;
                        break;
                    }
                }
                if (found) {
                    break;
                }
            }
            Function contractTransaction = contract.GetFunction(Form.FuncBind);
            object[] paramsToCall = Menu.ParametersToObjectField(inputs);
            if (paramsToCall.Length == 0) {
                paramsToCall = null;
            }
            if (String.IsNullOrEmpty(paymentValue)) {
                paymentValue = "0";
            }
            //BigInteger paymentValueInt = Web3.Convert.ToWei(BigInteger.Parse(paymentValue));
            BigInteger paymentValueInt = BigInteger.Parse(paymentValue);
            HexBigInteger paymentValueHex = new HexBigInteger(paymentValueInt);
            string transactionHash = await contractTransaction.SendTransactionAsync(MyETHAddress, new HexBigInteger(BigInteger.Parse("2100000")), paymentValueHex, paramsToCall);
            var receipt = await w3.Eth.Transactions.GetTransactionReceipt.SendRequestAsync(transactionHash);
            int maxAttempts = 0;
            while (receipt == null){
                Thread.Sleep(1000);
                receipt = await w3.Eth.Transactions.GetTransactionReceipt.SendRequestAsync(transactionHash);
                if (maxAttempts++ > 30) {
                    break;
                }
            }
            Menu.LoadFormData(Menu.SelectedNode);
        }
    }

    public class DasContractItem {        
        public string ContractAddress { get; set; }
        public DContract DasContract { get; set; }

        public DasContractItem(string contractForm, string address) {
            using (TextReader reader = new StringReader(contractForm)) {
                XmlSerializer serializer = create_throwing_serializer();
                XmlReader xmlreader = new XmlTextReader(reader);
                try {
                    DasContract = (DContract)serializer.Deserialize(xmlreader);
                } catch (Exception e) {
                    Console.WriteLine("Error parsing XML!\n" + $"Error:\n{e.Message}\n{e.StackTrace}");
                    return;
                }
            }
            ContractAddress = address;
        }
        
        private void Serializer_Throw(object sender, XmlElementEventArgs e) {
            throw new Exception("XML format exception.");
        }
        private void Serializer_Throw(object sender, XmlAttributeEventArgs e) {
            throw new Exception("XML format exception.");
        }
        private void Serializer_Throw(object sender, XmlNodeEventArgs e) {
            throw new Exception("XML format exception.");
        }
        
        private XmlSerializer create_throwing_serializer() {
            XmlSerializer serializer = new XmlSerializer(typeof(DContract));
            serializer.UnknownAttribute += new XmlAttributeEventHandler(Serializer_Throw);
            serializer.UnknownElement += new XmlElementEventHandler(Serializer_Throw);
            serializer.UnknownNode += new XmlNodeEventHandler(Serializer_Throw);
            return serializer;
        }
    }

    public class DasContractMenu {
        public Index Component { get; set; }
        public DForm _DForm { get; set; }
        public Web3 w3 { get; set; }
        public List<TreeNodeModel> ViewRoots { get; set; } = new List<TreeNodeModel>();
        public List<TreeNodeModel> ViewRootsDisplayed { get; set; } = new List<TreeNodeModel>();
        private TreeNodeModel selectedNode;
        public TreeNodeModel SelectedNode {
            get {
                return selectedNode;
            }
            set {
                if (value?.Form != null) {
                    selectedNode = value;
                    LoadFormData(selectedNode);
                } else if (value != null) {
                    value.IsExpanded = !value.IsExpanded;
                }
            }
        }
        public List<DasContractItem> availableContracts = new List<DasContractItem>();
        public bool existingDialogIsOpen = false;
        public bool newDialogIsOpen = false;
        public string dasContractConstructorParams = "";
        public string dasContractByteCode = "";
        public string dasContractAddress = "";
        public string dasFormFile = "";
        public string SelectedAccount = "";

        public async void LoadFormData(TreeNodeModel item) {
            if (item == null) {
                return;
            }

            foreach (FieldGroup fieldGroup in item.Form.FieldGroups) {
                foreach (Field field in fieldGroup.Fields) {
                    if (!String.IsNullOrEmpty(field.ViewBind)) {
                        string fixated = "const:";
                        if (field.ViewBind.Substring(0, fixated.Length) == fixated) {
                            string remainder = field.ViewBind.Substring(fixated.Length);
                            if (remainder == "myAccountAddress") {
                                field.SetData(SelectedAccount);
                            } else if (remainder == "myContractAddress") {
                                field.SetData(item.DasContractItem.ContractAddress);
                            } else {
                                field.SetData(remainder);
                            }
                        } else {
                            Contract contract = w3.Eth.GetContract(item.DasContractItem.DasContract.ABI, item.DasContractItem.ContractAddress);
                            ViewToken tokenized = TokenizeCall(field.ViewBind);
                            Function dataView = contract.GetFunction(tokenized.FuncName);
                            
                            List<object> inputs = new List<object>();
                            inputs.AddRange(tokenized.Parameters);
                            object[] paramsToCall = ParametersToObjectField(inputs);
                            List<ParameterOutput> retValues = await dataView.CallDecodingToDefaultAsync(paramsToCall);
                            List<string> output = OutputFromResult(retValues, tokenized, field);
                            if (output.Count == 1) {
                                field.SetData(output[0]);
                            } else {
                                field.SetDataList(output);
                            }
                        }
                    }
                }
            }
            UpdateMenuView();
            _DForm.refresh();
        }

        private List<string> OutputFromResult(List<ParameterOutput> retValues, ViewToken tokenized, Field field) {
            List<string> output = new List<string>();
            List<ParameterOutput> outputsToProcess = new List<ParameterOutput>();
            if (!String.IsNullOrEmpty(tokenized.Property)) {                
                foreach (ParameterOutput retValue in retValues) {
                    if (retValue.Parameter.Name == tokenized.Property) {
                        outputsToProcess.Add(retValue);
                        break;
                    }    
                }
            } else {
                outputsToProcess.AddRange(retValues);
            }

            if (outputsToProcess.Count == 1) {
                ParameterOutput singleReturn = outputsToProcess[0];
                if (IsIterable(singleReturn.Parameter.DecodedType)) {
                    List<object> resArray = (List<object>)singleReturn.Result;
                    if (tokenized.Index >= 0) {
                        if (resArray.Count > tokenized.Index) {
                            output.Add(resArray[tokenized.Index].ToString());
                        } else {
                            Console.WriteLine($"Ignoring field {field.Label}. Index out of bounds for array retrieved from {field.ViewBind}!");
                        }                                            
                    } else {
                        foreach (object res in resArray) {
                            output.Add(res.ToString());
                        }
                    }
                } else {
                    output.Add(singleReturn.Result.ToString());
                }
            } else {
                if (tokenized.Index >= 0) {
                    if (outputsToProcess.Count > tokenized.Index) {
                        ParameterOutput singleReturn = outputsToProcess[tokenized.Index];
                        if (IsIterable(singleReturn.Parameter.DecodedType)) {
                            List<object> resArray = (List<object>)singleReturn.Result;
                            foreach (object res in resArray) {
                                output.Add(res.ToString());
                            }
                        } else {
                            output.Add(singleReturn.Result.ToString());
                        }
                    } else {
                        Console.WriteLine($"Ignoring field {field.Label}. Index out of bounds for parameter order from {field.ViewBind}!");
                    }   
                } else {
                    foreach (ParameterOutput singleReturn in outputsToProcess) { 
                        if (IsIterable(singleReturn.Parameter.DecodedType)) {
                            List<object> resArray = (List<object>)singleReturn.Result;
                            foreach (object res in resArray) {
                                output.Add(res.ToString());
                            }
                        } else {
                            output.Add(singleReturn.Result.ToString());
                        }
                    }
                }
            }

            return output;            
        }

        private string TokenizeParams(ViewToken token, string prepend, string format) {
            if (format == ")") {
                return prepend;
            }

            string[] second = format.Split(')');
            foreach (string funcParam in second[0].Split(',')) {
                token.Parameters.Add(funcParam);
            }
            if (second.Length == 1) {
                return prepend;
            }
            return prepend + second[1];    
        }

        private string TokenizeProperty(ViewToken token, string prepend, string format) {
            string[] third = format.Split('[');
            if (third.Length == 1) {
                token.Property = format;
                return prepend;
            }
            token.Property = third[0];
            return prepend + '[' + third[1];
        }

        private ViewToken TokenizeCall(string format) {
            format = format.Replace(" ", String.Empty);
            ViewToken token = new ViewToken();

            string[] first = format.Split('(');
            if (first.Length == 2) {
                format = TokenizeParams(token, first[0], first[1]);
            }

            string[] second = format.Split('.');
            if (second.Length == 2) {
                format = TokenizeProperty(token, second[0], second[1]);
            }

            string[] third = format.Split('[');
            if (third.Length == 2) {
                token.FuncName = third[0];
                string indexer = third[1].Replace("]", String.Empty);
                token.Index = Convert.ToInt32(indexer);                
            } else {
                token.FuncName = format;
            }

            return token;
        }

        public object[] ParametersToObjectField(List<object> parameters) {
            for (int i = 0; i < parameters.Count; ++i) {
                object res = parameters[i];
                if (res.ToString().Length > 1 && res.ToString().Substring(0, 2) == "0x") {
                    continue;
                }
                try {
                    BigInteger serializedRes = BigInteger.Parse(res.ToString());
                    parameters[i] = serializedRes;
                } catch (Exception e) {
                    continue;
                }
            }
            var result = parameters.Cast<object>().ToArray();
            return result;
        }

        private bool IsIterable(Type type) {
            return typeof(IEnumerable).IsAssignableFrom(type) && type != typeof(string);
        }
    
        public void LoadDashboard() {
            selectedNode = null;
        }

        public bool ItemIsExpanded(TreeNodeModel model) {
            return model.IsExpanded;
        }

        public void OpenNewContractDialog() {
            newDialogIsOpen = true;
        }

        public void OpenExistingContractDialog() {
            existingDialogIsOpen = true;
        }
 
        public async void SubmitNewContractDialog() {
            DasContractItem item = new DasContractItem(dasFormFile, "");
            dasContractConstructorParams = dasContractConstructorParams.Replace(" ", String.Empty);
            string[] parameters = dasContractConstructorParams.Split(',');
            List<object> inputs = new List<object>();
            inputs.AddRange(parameters);
            object[] paramsToCall = ParametersToObjectField(inputs);
            if (String.IsNullOrEmpty(dasContractConstructorParams)) {
                paramsToCall = null;
            }
            var estimateGas = await w3.Eth.DeployContract.EstimateGasAsync(item.DasContract.ABI, dasContractByteCode, SelectedAccount, paramsToCall);
            var receipt = await w3.Eth.DeployContract.SendRequestAndWaitForReceiptAsync(item.DasContract.ABI, dasContractByteCode, SelectedAccount, estimateGas, null, paramsToCall);
            item.ContractAddress = receipt.ContractAddress;
            availableContracts.Add(item);            
            TreeNodeModel root = new TreeNodeModel(item.DasContract.Name);
            foreach (Form form in item.DasContract.Forms) {
                root.Nodes.Add(new TreeNodeModel(form.Label, SelectedAccount, w3, this, item, form));
            }
            ViewRoots.Add(root);
            UpdateMenuView();
            newDialogIsOpen = false;
            dasContractByteCode = "";
            dasContractAddress = "";
            dasContractConstructorParams = "";
            _DForm.refresh();
        }

        public void CancelNewContractDialog() {
            newDialogIsOpen = false;
            dasContractByteCode = "";
            dasContractAddress = "";
        }
 
        public void SubmitExistingContractDialog() {
            DasContractItem item = new DasContractItem(dasFormFile, dasContractAddress);
            availableContracts.Add(item);            
            TreeNodeModel root = new TreeNodeModel(item.DasContract.Name);

            foreach (Form form in item.DasContract.Forms) {
                root.Nodes.Add(new TreeNodeModel(form.Label, SelectedAccount, w3, this, item, form));
            }
            ViewRoots.Add(root);
            UpdateMenuView();
            existingDialogIsOpen = false;
            dasContractByteCode = "";
            dasContractAddress = "";
            _DForm.refresh();
        }

        public void CancelExistingContractDialog() {
            existingDialogIsOpen = false;
            dasContractByteCode = "";
            dasContractAddress = "";
        }

        public async Task LoadFilesDialog(InputFileChangeEventArgs e) {
            try {
                foreach (var file in e.GetMultipleFiles(1)) {
                    using var reader = new StreamReader(file.OpenReadStream(100*1024));
                    dasFormFile = await reader.ReadToEndAsync();
                }
            } catch (Exception ex) {
                Console.WriteLine(ex.Message);
            }
        }

        public async void UpdateMenuView() {
            List<TreeNodeModel> ViewRootsDisplayedTmp = new List<TreeNodeModel>();
            foreach (TreeNodeModel node in ViewRoots) {
                TreeNodeModel root = new TreeNodeModel(node.Name);
                if (await UpdateNodeView(root, node)) {
                    ViewRootsDisplayedTmp.Add(root);
                }
            }
            ViewRootsDisplayed = ViewRootsDisplayedTmp;
            Component.StateHasChanged();
        }

        public async Task<bool> UpdateNodeView(TreeNodeModel root, TreeNodeModel node) {
            foreach (TreeNodeModel item in node.Nodes) {
                if ((await StateMachineValid(item)) && (await RoleValid(item))) {
                    root.Nodes.Add(item);
                }
            }

            return root.Nodes.Count > 0;
        }

        public async Task<bool> StateMachineValid(TreeNodeModel item) {
            if (String.IsNullOrEmpty(item.Form.FuncBind) || String.IsNullOrEmpty(item.Form.StateMachine)) {
                return true;
            }

            try {
                Contract contract = w3.Eth.GetContract(item.DasContractItem.DasContract.ABI, item.DasContractItem.ContractAddress);
                Function stateView = contract.GetFunction(item.Form.StateMachine);                            
                List<object> inputs = new List<object>();
                inputs.Add(item.Form.FuncBind);
                object[] paramsToCall = ParametersToObjectField(inputs);
                List<ParameterOutput> retValues = await stateView.CallDecodingToDefaultAsync(paramsToCall);

                return Convert.ToBoolean(retValues[0].Result.ToString());
            } catch (Exception e) {
                return false;
            }
        }

        public async Task<bool> RoleValid(TreeNodeModel item) {
            if (String.IsNullOrEmpty(item.Form.Role) || String.IsNullOrEmpty(item.Form.RoleMachine)) {
                return true;
            }

            try {
                Contract contract = w3.Eth.GetContract(item.DasContractItem.DasContract.ABI, item.DasContractItem.ContractAddress);
                Function roleView = contract.GetFunction(item.Form.RoleMachine);                            
                List<object> inputs = new List<object>();
                inputs.Add(item.Form.Role);
                object[] paramsToCall = ParametersToObjectField(inputs);
                List<ParameterOutput> retValues = await roleView.CallDecodingToDefaultAsync(paramsToCall);
                string address = retValues[0].Result.ToString();

                return address == "0x0000000000000000000000000000000000000000" || address.ToLower() == SelectedAccount.ToLower();
            } catch (Exception e) {
                return false;
            }
        }
    }

    class ViewToken {
        public string FuncName { get; set; } = "";
        public List<string> Parameters { get; set; } = new List<string>();
        public string Property { get; set; } = "";
        public int Index { get; set; } = -1;
    }
}